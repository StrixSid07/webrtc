<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WebRTC Host</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 text-gray-900">
    <div class="max-w-4xl mx-auto p-6">
      <h1 class="text-3xl font-bold text-center mb-6">WebRTC Host</h1>

      <div class="flex gap-4 mb-4">
        <input
          id="roomInput"
          type="text"
          placeholder="Room ID"
          class="border rounded px-4 py-2 w-full"
        />
        <button
          onclick="startHost()"
          class="bg-blue-600 text-white px-4 py-2 rounded"
        >
          Start Hosting
        </button>
        <button
          id="stopBtn"
          onclick="stopStream()"
          class="bg-red-600 text-white px-4 py-2 rounded hidden"
        >
          Stop
        </button>
      </div>

      <p id="status" class="text-center text-sm text-gray-600 mb-4"></p>

      <div>
        <h2 class="font-semibold">Local Video</h2>
        <video
          id="localVideo"
          autoplay
          muted
          playsinline
          class="rounded shadow w-full"
        ></video>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let localStream = null;
      let peerConnections = {};
      const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

      const roomInput = document.getElementById("roomInput");
      const status = document.getElementById("status");
      const localVideo = document.getElementById("localVideo");
      const stopBtn = document.getElementById("stopBtn");

      function setStatus(msg) {
        status.textContent = msg;
      }

      async function startHost() {
        const roomId = roomInput.value.trim();
        if (!roomId) {
          alert("Enter Room ID");
          return;
        }

        setStatus("Starting as host...");
        socket.emit("join-room", { roomId, isHost: true });

        try {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 360, frameRate: { max: 15 } },
            audio: true,
          });
          localVideo.srcObject = localStream;
          stopBtn.classList.remove("hidden");
          setStatus("Waiting for viewers to join...");
        } catch (e) {
          alert("Error accessing camera: " + e.message);
          setStatus("Error");
        }
      }

      function stopStream() {
        if (localStream) {
          localStream.getTracks().forEach((t) => t.stop());
          localStream = null;
          localVideo.srcObject = null;
        }
        for (let id in peerConnections) {
          peerConnections[id].close();
        }
        peerConnections = {};
        socket.emit("stop-stream");
        stopBtn.classList.add("hidden");
        setStatus("Stream stopped.");
      }

      function createPeerConnection(remoteId) {
        const pc = new RTCPeerConnection(config);

        pc.onicecandidate = (e) => {
          if (e.candidate) {
            socket.emit("ice-candidate", {
              to: remoteId,
              candidate: e.candidate,
            });
          }
        };

        localStream
          .getTracks()
          .forEach((track) => pc.addTrack(track, localStream));

        return pc;
      }

      // ðŸ”¥ Create offer immediately for each new viewer
      socket.on("user-joined", async (id) => {
        setStatus(`Viewer ${id} joined`);
        const pc = createPeerConnection(id);
        peerConnections[id] = pc;

        try {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          socket.emit("offer", { to: id, sdp: offer });
        } catch (e) {
          console.error(e);
        }
      });

      socket.on("answer", async (data) => {
        const pc = peerConnections[data.from];
        if (pc) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        }
      });

      socket.on("ice-candidate", async (data) => {
        const pc = peerConnections[data.from];
        if (pc) {
          try {
            await pc.addIceCandidate(data.candidate);
          } catch (e) {
            console.error(e);
          }
        }
      });

      socket.on("host-exists", () => {
        alert("Host already exists in this room.");
        setStatus("Host already exists.");
      });

      socket.on("user-left", (id) => {
        if (peerConnections[id]) {
          peerConnections[id].close();
          delete peerConnections[id];
          setStatus(`Viewer ${id} left.`);
        }
      });
    </script>
  </body>
</html>
